- hosts: all

  hosts: localhost
  connection: local  
  become: true

  vars_files:
   - group_vars/system.yml
#   - secret_group_vars/system.vault    

  tasks:
    - name: add repos
      include: tasks/repos.yml
      tags: repos

    - name: Install packages
      include: tasks/base_packages.yml
      tags: 'base_packages'

    - name: Create users and groups
      include: tasks/users_groups.yml
      tags: 'users'
    - name: Install influxdb and grafana
      include: tasks/influxdb.yml
      tags: 'influxdb'

    - name: configure autofs
      include: tasks/autofs.yml
      loop: "{{ storage | dict2items }}"
      loop_control:
        loop_var: group

    - name: restart autofs
      service:
        name: autofs
        enabled: yes
        state: restarted


  roles:
    - geerlingguy.java
    - dj-wasabi.telegraf
#    - neuro-sysmed.linux-vm

